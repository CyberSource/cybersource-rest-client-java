name: Java workflow to run Java rest Samples
on:
  push:
env:
  CLIENT_FOLDER: 'cybersource-rest-client-java'
  SAMPLE_FOLDER: 'cybersource-rest-samples-java'
jobs:
    complete-job:
        defaults:
            run:
              shell: bash
        strategy:
            fail-fast: false
            matrix:
              operating-system: [ubuntu-latest,macos-latest,windows-latest]
              java-version: ['8','11','16','17','18','19','20','21','22']
        runs-on: ${{matrix.operating-system}}
        steps:
            - name: Making separate folders
              run: |
                rm -rf $CLIENT_FOLDER
                rm -rf $SAMPLE_FOLDER
                mkdir $CLIENT_FOLDER $SAMPLE_FOLDER
            - name: Adding client repo
              uses: actions/checkout@v4
              with:
                path: ${{env.CLIENT_FOLDER}}
            - name: Adding sample repo
              uses: actions/checkout@v4
              with:
                repository: 'CyberSource/cybersource-rest-samples-java'
                ref: 'testing-branch'
                path: ${{env.SAMPLE_FOLDER}}
            - name: Replace the Version of Cybersource Client in Samples
              run: |
                cd $CLIENT_FOLDER
                RESTCLIENT_SDK_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
                echo $RESTCLIENT_SDK_VERSION
                cd ../$SAMPLE_FOLDER
                perl -i -spe "BEGIN{undef $/;} s|<groupId>com\.cybersource<\/groupId>\s*<artifactId>cybersource-rest-client-java<\/artifactId>\s*<version>.*?<\/version>|<groupId>com.cybersource</groupId>\n   <artifactId>cybersource-rest-client-java</artifactId>\n  <version>\${version}</version>|gs" -- -version=$RESTCLIENT_SDK_VERSION pom.xml
                cat pom.xml
            - name: Setup Java 8 for building the client
              uses: actions/setup-java@v2
              with:
                distribution: 'temurin'
                java-version: '8'
            - name: Building the Java Client
              run:
                mvn -version
                java -version
                cd $CLIENT_FOLDER
                mvn -X -e clean install
                echo Build Successful
            - name: Setup Java version for building the samples
              uses: actions/setup-java@v2
              with:
                distribution: 'temurin'
                java-version: ${{matrix.java-version}}
            - name: Building the Projects
              run: |
                mvn -version
                java -version
                # cd $CLIENT_FOLDER
                # RESTCLIENT_SDK_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
                # echo $RESTCLIENT_SDK_VERSION
                cd $SAMPLE_FOLDER
                # perl -i -spe "BEGIN{undef $/;} s|<groupId>com\.cybersource<\/groupId>\s*<artifactId>cybersource-rest-client-java<\/artifactId>\s*<version>.*?<\/version>|<groupId>com.cybersource</groupId>\n   <artifactId>cybersource-rest-client-java</artifactId>\n  <version>\${version}</version>|gs" -- -version=$RESTCLIENT_SDK_VERSION pom.xml
                # cat pom.xml
                # sed "s|<groupId>com\.cybersource<\/groupId>\s*<artifactId>cybersource-rest-client-java<\/artifactId>\s*<version>.*<\/version>|<groupId>com.cybersource</groupId>\n   <artifactId>cybersource-rest-client-java</artifactId>\n  <version>${RESTCLIENT_SDK_VERSION}</version>|g" pom.xml > temp && mv temp pom.xml
                mvn -X -e clean install
                cd target
                # java -jar SampleCode.jar > ../output.log
                echo HI > ../output.log
            - name: Using Report Generation Action
              id: report-generation
              uses: ./cybersource-rest-client-java/.github/actions/generate-report
              with:
                lang: java
                sample-folder-name: ${{env.SAMPLE_FOLDER}}
                log-file-name: output.log
            - name: Upload Test Reports
              uses: actions/upload-artifact@v4
              with:
                name: sample-run-report-${{matrix.operating-system}}-java-ver-${{matrix.java-version}}
                path: |
                  ${{env.SAMPLE_FOLDER}}/${{steps.report-generation.outputs.result-pdf-name}}

